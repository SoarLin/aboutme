(function(t,e){t.widget("mobile.lazyloader",t.mobile.widget,{_defaultOptions:{threshold:t(window).height(),retrieve:20,retrieved:20,bubbles:false,offset:0},_defaultParameters:{retrieve:20,retrieved:20,offset:0},_defaultSettings:{pageId:"",templateType:"",templatePrecompiled:false,templateId:"",template:"",mainId:"",progressDivId:"",moreUrl:"",clearUrl:"",JSONP:false,JSONPCallback:""},_defaultSelectors:{main:"ul",single:"ul li",bottom:'[data-role="list-divider"]'},_handleScrollStartJustFired:false,_handleScrollStopJustFired:false,_mouseWheelEventJustFired:false,_handleScrollStartTimeoutId:null,_handleScrollStopTimeoutId:null,_mouseWheelTimeoutId:null,_instances:{},_moreOutstandingPageId:null,_parameters:null,_settings:null,_selectors:null,timeoutOptions:{mousewheel:350,scrollstart:500,scrollstop:50,showprogress:200,scrolldown:400,immediately:0},_widgetName:"lazyloader",_widgetState:{busy:false,done:false},_create:function(){this._initialize(this._defaultOptions,this._defaultSettings,this._defaultParameters,this._defaultSelectors);this._bind()},_init:function(){},_initialize:function(e,s,i,a){if(typeof e!="undefined"&&e!=""){this._widgetState.busy=false;this._widgetState.done=false;this._settings=t.extend(true,this._settings,this._defaultSettings);this._settings=t.extend(true,this._settings,s);if(typeof this._settings.mainId!=="undefined"&&this._settings.mainId!==""){this._defaultSelectors.main="#"+this._settings.mainId;this._defaultSelectors.single="#"+this._settings.mainId+" li";this._defaultSelectors.bottom='[data-role="list-divider"]'}if(typeof this._settings.pageId!=="undefined"&&this._settings.pageId!==""){this._settings.totalHeight=t("#"+this._settings.pageId).height()}this._selectors=t.extend(true,this._selectors,this._defaultSelectors);this._selectors=t.extend(true,this._selectors,a);this._parameters=t.extend(true,this._parameters,this._defaultParameters);this._parameters=t.extend(true,this._parameters,i);this.options=t.extend(true,this.options,this._defaultOptions);this.options=t.extend(true,this.options,e);var n=s.pageId;if(typeof n!="undefined "&&n!=""){if(!this._instances[n]){if(typeof this._settings.template=="undefined"||this._settings.template==""){if(typeof this._settings.templateId!="undefined"&&this._settings.templateId!=""){var l=t("#"+this._settings.templateId).html();var r="";var o=this._settings.templatePrecompiled;if(typeof this._settings.templateType!="undefined"&&this._settings.templateType!=""){r=this._settings.templateType}if(r==="dust"&&l!==""&&!o){this._settings.template=dust.compile(l,this._settings.templateId)}else{this._settings.template=l}}}this._instances[n]=[];this._instances[n]["options"]=t.extend(true,{},this.options);this._instances[n]["settings"]=t.extend(true,{},this._settings);this._instances[n]["selectors"]=t.extend(true,{},this._selectors)}}}},_bind:function(){t("body").bind("scrollstart",t.proxy(this._handleScrollStart,this));t("body").bind("scrollstop",t.proxy(this._handleScrollStop,this));if(/Firefox/i.test(navigator.userAgent)){t(window).bind("DOMMouseScroll",t.proxy(this._handleMouseWheelEvent,this))}else{if(typeof this._selectors!="undefined"&&this._selectors!=null&&this._selectors!=""){if(typeof this._selectors.main!="undefined"){if(t(this._selectors.main).attachEvent){t(window).bind("onmousewheel",t.proxy(this._handleMouseWheelEvent,this))}else{t(window).bind("mousewheel",t.proxy(this._handleMouseWheelEvent,this))}}}}},_unbind:function(){t("body").unbind("scrollstart",this._handleScrollStart);t("body").unbind("scrollstop",this._handleScrollStop);if(/Firefox/i.test(navigator.userAgent)){t(window).unbind("DOMMouseScroll",this._handleMouseWheelEvent)}else{if(typeof this._selectors!="undefined"&&this._selectors!=null&&this._selectors!=""){if(typeof this._selectors.main!="undefined"){if(t(this._selectors.main).attachEvent){t(window).unbind("onmousewheel",this._handleMouseWheelEvent)}else{t(window).unbind("mousewheel",this._handleMouseWheelEvent)}}}}},destroy:function(){this._unbind();this.options=null;this.timeoutOptions=null;this._settings=null;this._parameters=null;this._instances=null;this._handleScrollStartJustFired=null;this._handleScrollStopJustFired=null;this._mouseWheelEventJustFired=null;this._handleScrollStartTimeoutId=null;this._handleScrollStopTimeoutId=null;this._mouseWheelTimeoutId=null;this._widgetState=null;this._defaultOptions=null;this._defaultSettings=null;this._defaultParameters=null;t.Widget.prototype.destroy.apply(this)},_check:function(e){e=this.options.threshold||e;var s,i,a,n;if(document.documentElement.scrollTop){a=document.documentElement.scrollTop}else{a=document.body.scrollTop}if(this._instances[this._settings.pageId]){s=this._instances[this._settings.pageId]["settings"].totalHeight;if(s>t("#"+this._settings.pageId).height())s=t("#"+this._settings.pageId).height();i=this._instances[this._settings.pageId]["settings"].singleItemHeight}else{s=this._settings.totalHeight;i=this._settings.singleItemHeight}n=t(window).height();return s-e<=a+n},_load:function(s){if(typeof this._settings.pageId!=e&&this._settings.pageId!=""){if(t(".ui-page-active").attr("id")==this._settings.pageId){if(!this._widgetState.busy&&!this._widgetState.done){this._moreOutstandingPageId=this._settings.pageId;$that=this;setTimeout(function(){if($that._moreOutstandingPageId==$that._settings.pageId){if($that._check($that.options.threshold)||s===0){t("#"+$that._settings.progressDivId).show($that.timeoutOptions.showprogress,function(){moreUrl=$that._settings.moreUrl;var e="POST";var s="json";var a="";var n=false;var l="";var r=0;if($that._instances[$that._settings.pageId]){$that._parameters.retrieve=$that._instances[$that._settings.pageId]["options"].retrieve;$that._parameters.retrieved=$that._instances[$that._settings.pageId]["options"].retrieved;$that._parameters.offset=$that._instances[$that._settings.pageId]["options"].offset;if($that._instances[$that._settings.pageId]["settings"].JSONP){n=true;l=$that._instances[$that._settings.pageId]["settings"].JSONPCallback}}else{$that._parameters.retrieve=$that.options.retrieve;$that._parameters.retrieved=$that.options.retrieved;$that._parameters.offset=$that.options.offset}if(typeof $that._settings.pageId!="undefined"&&$that._settings.pageId!=""){var o=t("#"+$that._settings.pageId).find('[type="hidden"]');for(i=0;i<o.length;i++){var h=t(o).get(i);if(typeof t(h).attr("id")!="undefined"&&t(h).attr("id")!=""){$that._parameters[t(h).attr("id")]=escape(t(h).val())}}}if(!n){for(var d in $that._parameters){if(r==0){a+=d+"="+$that._parameters[d]}else{a+="&"+d+"="+$that._parameters[d]}r=r+1}}else{e="GET";s="jsonp";var _="";for(var d in $that._parameters){if(r==0){_+='"'+d+'"'+': "'+$that._parameters[d]+'"'}else{_+=", "+'"'+d+'"'+': "'+$that._parameters[d]+'"'}r=r+1}a=t.parseJSON("{ "+_+" }")}t.ajax({type:e,url:moreUrl,dataType:s,jsonpCallback:l,data:a,success:function(e){more=e;if(typeof e==="object"){}else{try{more=t.parseJSON(e)}catch(s){$that._triggerEvent("error","_load",s.message);t("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false});return false}}try{var i=more.data[0].count;var a="";var n="";var l="";var r="";var o="";var h=false;var d="";var _="";var g="";var p="";if(i>0){d=$that._selectors.main;_=$that._selectors.single;g=$that._selectors.bottom;p=$that._getBottomElement(d,g);if(typeof more.data[0].html!="undefined"&&more.data[0].html!=""){a=more.data[0].html;if(p){t(_).last().before(a)}else{t(d).append(a)}}else{if($that._instances[$that._settings.pageId]){if(typeof $that._instances[$that._settings.pageId]["settings"].templateId!="undefined"&&$that._instances[$that._settings.pageId]["settings"].templateId!=""){r=$that._instances[$that._settings.pageId]["settings"].templateId;if(typeof $that._instances[$that._settings.pageId]["settings"].templateType!="undefined"&&$that._instances[$that._settings.pageId]["settings"].templateType!=""){o=$that._instances[$that._settings.pageId]["settings"].templateType}if(typeof $that._instances[$that._settings.pageId]["settings"].template!="undefined"&&$that._instances[$that._settings.pageId]["settings"].template!=""){l=$that._instances[$that._settings.pageId]["settings"].template}}h=$that._instances[$that._settings.pageId]["settings"].templatePrecompiled}else{if(typeof $that._settings.templateId!="undefined"&&$that._settings.templateId!=""){r=$that._settings.templateId;if(typeof $that._settings.templateType!="undefined"&&$that._settings.templateType!=""){o=$that._settings.templateType}if(typeof $that._settings.template!="undefined"&&$that._settings.template!=""){l=$that._settings.template}}h=$that._settings.templatePrecompiled}if(o!==""&&r!==""&&l!==""){if(o==="json2html"){n=more.data[0].json;if(p){p.remove()}t(d).json2html(n,l);if(p){t(_).last().append(p)}}else{n=more.data[0];switch(o){case"handlebars":if(h){l=Handlebars.templates[r+".tmpl"];a=l(n)}else{l=Handlebars.compile(l);a=l(n)}break;case"icanhaz":ich.addTemplate("listitem",l);a=ich.listitem(n,true);ich.clearAll();break;case"dust":if(h){dust.render(r,n,function(t,e){a=e})}else{dust.loadSource(l);dust.render(r,n,function(t,e){a=e})}break;case"dot":l=doT.template(l);a=l(n);break;default:break}if(p){t(_).last().before(a)}else{t(d).append(a)}}}else{}}t(d).listview("refresh");callback=$that._instances[$that._settings.pageId]["settings"].callback;if(typeof callback==="function"){callback()}var u=0;i=parseInt(i);if($that._instances[$that._settings.pageId]){var f=$that._instances[$that._settings.pageId]["settings"].totalHeight;if(typeof $that._instances[$that._settings.pageId]["settings"].singleItemHeight!=="undefined"){u=$that._instances[$that._settings.pageId]["settings"].singleItemHeight}else{u=t(_).first().next().height();$that._instances[$that._settings.pageId]["settings"].singleItemHeight=u}$that._instances[$that._settings.pageId]["settings"].totalHeight=f+u*i}else{if(typeof $that._settings.singleItemHeight!=="undefined"){u=$that._settings.singleItemHeight}else{u=t(_).first().next().height();$that._settings.singleItemHeight=u}$that._settings.totalHeight=$that._settings.totalHeight+$that._settings.singleItemHeight*i}$that._instances[$that._settings.pageId]["options"].retrieved+=i;if(i<$that.options.retrieve||$that.options.retrieve=="all"){$that._widgetState.done=true;$that._triggerEvent("alldone","_load")}}else{$that._widgetState.done=true;$that._triggerEvent("alldone","_load")}t("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false});$that._triggerEvent("doneloading","_load")}catch(s){$that._triggerEvent("error","_load",s.message);t("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false});return false}},error:function(e){$that._triggerEvent("error","_load",e);t("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false})},complete:function(t){}})})}}},s)}else{if(this._widgetState.done){$that._triggerEvent("alldone","_load")}else if(this._widgetState.busy){$that._triggerEvent("busy","_load")}else{}}}else{t("#"+this._settings.progressDivId).hide(250,function(){if(typeof this._widgetState!="undefined"){this._widgetState.busy=false}})}}},_getBottomElement:function(e,s){var i=t(e).last().find(s);switch(i.length){case 2:i=i.last();break;case 1:case 0:default:i=null;break}if(typeof i!="undefined"&&i!=null&&i!=""&&i!="null"){return i}else{return false}},_handleMouseWheelEvent:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._mouseWheelEventJustFired=true;this._load(this.timeoutOptions.mousewheel);var t=this;this._mouseWheelTimeoutId=setTimeout(function(){t._mouseWheelEventJustFired=false},1e3)}},_handleScrollStart:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._handleScrollStartJustFired=true;this._load(this.timeoutOptions.scrollstart);var t=this;this._handleScrollStartTimeoutId=setTimeout(function(){t._handleScrollStartJustFired=false},1200)}},_handleScrollStop:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._handleScrollStopJustFired=true;this._load(this.timeoutOptions.scrollstop);var t=this;this._handleScrollStopTimeoutId=setTimeout(function(){t._handleScrollStopJustFired=false},1200)}},loadMore:function(t){if(t===0){this._load(this.timeoutOptions.immediately)}else{this._load(this.timeoutOptions.scrolldown)}},_setOption:function(e,s){if(this._instances[this._settings.pageId]){if(this._instances[this._settings.pageId]["options"][e]){this._instances[this._settings.pageId]["options"][e]=s}}t.Widget.prototype._setOption.apply(this,arguments)},refresh:function(e){if(e=="parameters"){if(typeof this.options!="undefined"){for(var s in this._parameters){if(typeof this.options[s]!="undefined"){this._parameters[s]=this.options[s]}}}}else if(e=="parameter"){var s=arguments[1];if(typeof this.options[s]!="undefined"){this._parameters[s]=this.options[s]}}else{}var i=JSON.stringify(this._parameters);this._parameters=t.parseJSON(i)},reInitialize:function(t,e,s,i){t=""||t;e=""||e;s=""||s;i=""||i;this._initialize(t,e,s,i)},reset:function(e){var s=this;function i(t){if(parseInt(t)){s.options.retrieved=s._defaultOptions.retrieved;s._widgetState.done=false;if(typeof s._instances[e]!="undefined"){delete s._instances[e]}var i="All session variables for the '"+e+"' page and the lazyloader instance variables have been cleared.";s._triggerEvent("reset","reset",i)}}if(!s._settings.clearUrl)return i(1);t.ajax({type:"POST",url:s._settings.clearUrl,async:true,data:"section="+e,success:i,error:function(e){s._triggerEvent("error","reset",e);t("#"+s._settings.progressDivId).hide(250,function(){s._widgetState.busy=false})}})},resetAll:function(){var e=this;t.ajax({type:"POST",url:e._settings.clearUrl,async:true,data:"",success:function(t){if(parseInt(t)){for(pageId in e._instances){delete e._instances[pageId]}e.options.retrieved=e._defaultOptions.retrieved;e._widgetState.done=false;e._widgetState.busy=false;var s="All session variables for all pages currently being tracked by the lazyloader have been cleared.";e._triggerEvent("resetall","resetAll",s)}}})},_triggerEvent:function(t,e,s){s=s||"";switch(t){case"error":case"resetall":this._trigger(t,{type:"lazyloader"+t,"function":e,message:s,settings:this._settings,options:this.options,parameters:this._parameters});break;default:this._trigger(t,{type:"lazyloader"+t,"function":e,message:s,pageId:this._settings.pageId,mainId:this._settings.mainId,loaded:this.options.retrieved});break}}});t(document).bind("pagecreate create",function(e){t.mobile.lazyloader.prototype.enhanceWithin(e.target)})})(jQuery);